# SQL 파일 비교 분석 보고서

**분석 일자**: 2025-10-15
**분석자**: Claude Code
**대상 파일**:
- 원본: `pc_sts_analy_srl_mid_match` (2,781 라인)
- 변경: `pc_sts_analy_srl_mid_match_avg_stdev_st` (1,076 라인)

---

## 1. 파일 메타데이터 변경

| 항목 | 원본 | 변경 |
|-----|------|------|
| **파일명** | pc_sts_analy_srl_mid_match | pc_sts_analy_srl_mid_match_avg_stdev_st |
| **라인 수** | 2,781 라인 | 1,076 라인 |
| **작성일** | 미표기 | 2025-10-14 |
| **작성자** | 미표기 | 하민규 |
| **목적** | 태그 원시 데이터 매칭 | 평균/표준편차 통계 계산 |

---

## 2. 대상 테이블 및 컬럼 구조 변경

### 원본 (Line 6)
```sql
INSERT INTO srl_tag.mid_stats_rt (
    heat_no, m_lot_no, lot_no_seq_no, ..., stats_sec_dtm,
    srlzone0301_1, srlzone0301_2, ..., srlzone21_46  -- 초 단위 배열 데이터
)
```

### 변경 (Line 17)
```sql
INSERT INTO comm_analy.sts_analy_srl_mid_match_avg_stdev_st (
    rm_work_dte, rm_entry_dtm, lot_no, serial_no, heat_no, strnd_no, strnd_seq,
    avg_srlzone0401_16, ...,      -- 평균값
    std_dev_srlzone0401_16, ...   -- 표준편차
)
```

**핵심 차이점**:
- 원본: 초 단위 시계열 배열 데이터 저장 (`ARRAY_AGG`)
- 변경: **집계된 통계값** 저장 (`AVG`, `STDDEV`)

---

## 3. 파라미터 선언 추가

### 변경 파일 (Line 8-15)
```sql
DECLARE p_datetime DATETIME DEFAULT DATETIME_SUB(CURRENT_DATETIME('Asia/Seoul'), INTERVAL 2 DAY);
DECLARE p_torque_std INT64 DEFAULT 5;  -- 토크 기준값

IF LENGTH(p_date) > 0 THEN
    SET p_datetime = DATETIME(p_date);
END IF;
```

**추가 이유**:
- 동적 날짜 설정 (기본값: 2일 전)
- 토크 임계값 정의 (기본값: 5)

---

## 4. CTE (WITH 절) 구조 차이

| CTE 이름 | 원본 | 변경 | 차이점 |
|---------|------|------|-------|
| **T1** | ✓ | ✗ | 원본: 전체 공정 추적 데이터 |
| **T2** | ✓ (초 단위 배열) | ✗ | 원본: `GENERATE_TIMESTAMP_ARRAY` |
| **T3-T6** | ✓ | ✗ | 원본: Zone 정보, 작업 지시 등 |
| **w** | ✗ | ✓ | 변경: 특정 강종 lot_no 필터링 (Line 36) |
| **cp3** | ✗ | ✓ | 변경: CP3 작업 결과 매핑 (Line 44) |
| **worked_billet_list** | ✗ | ✓ | 변경: 특정 Zone 통과 빌렛 (Line 53) |
| **trk** | ✗ | ✓ | 변경: 추적 데이터 (이상치 제외, Line 66) |
| **sec** | ✗ | ✓ | 변경: 초 단위 시간 배열 (Line 106) |
| **z0401~z13** | Z0301~Z2100 (25개) | z0401~z13 (11개) | 변경: Zone 범위 축소 |

**핵심 차이점**:
- 원본: 전체 Zone (25개) 데이터 수집
- 변경: **특정 Zone만 선택** (11개) + **이상치 필터링**

### 대상 강종 필터링 (Line 42)
```sql
company_steel_grade_name in ('316LDS1', 'STS410S5','STS304SX','STS303S1','316LDSZ')
```

---

## 5. 데이터 필터링 로직 추가 ⭐ **핵심**

### 원본 (Line 1392-1416)
```sql
SELECT ...,
    T2.stats_sec_dtm,
    Z0401.* EXCEPT(zone_cd, stats_sec_dtm),  -- 원시 데이터 그대로
    ...
```

### 변경 (Line 715-1044) - **3가지 주요 필터링 추가**

#### ① **토크 기반 시간 범위 필터링**
```sql
-- Line 718, 722, 726, 등
CASE WHEN sec.stats_sec_dtm BETWEEN
    MIN(CASE WHEN ABS(srlzone0401_16) >= p_torque_std THEN sec.stats_sec_dtm END)
        OVER (PARTITION BY lot_no, lot_no_seq_no)
    AND
    MAX(CASE WHEN ABS(srlzone0401_16) >= p_torque_std THEN sec.stats_sec_dtm END)
        OVER (PARTITION BY lot_no, lot_no_seq_no)
THEN srlzone0401_16 END AS srlzone0401_16
```

**의미**:
- 토크가 5 이상인 구간만 선택
- 실제 압연이 진행 중인 시간대만 추출
- 설비 대기 시간 제외

**적용 대상**:
- STAND 압연기 토크 데이터
- 각 STAND별 관련 센서 데이터

#### ② **온도 임계값 필터링**
```sql
-- Line 752
CASE WHEN srlzone0401_4 > 600 THEN srlzone0401_4 END AS srlzone0401_4  -- ZONE04 온도

-- Line 788
CASE WHEN srlzone0402_1 > 400 THEN srlzone0402_1 END AS srlzone0402_1  -- ZONE04 온도

-- Line 843
CASE WHEN srlzone07_2 > 600 THEN srlzone07_2 END AS srlzone07_2  -- ZONE07 온도
```

**의미**:
- 일정 온도 이하 데이터 제외
- 설비 대기/비가동 시간 제거
- 실제 압연 온도 구간만 수집

#### ③ **이상치 제거 (Outlier Detection)**
```sql
-- Line 754, 755 (냉각수 유량)
CASE WHEN srlzone0401_7 BETWEEN
    AVG(srlzone0401_7) OVER (PARTITION BY lot_no, lot_no_seq_no) -
        (1.5 * STDDEV(srlzone0401_7) OVER (PARTITION BY lot_no, lot_no_seq_no))
    AND
    AVG(srlzone0401_7) OVER (PARTITION BY lot_no, lot_no_seq_no) +
        (1.5 * STDDEV(srlzone0401_7) OVER (PARTITION BY lot_no, lot_no_seq_no))
THEN srlzone0401_7 END AS srlzone0401_7

-- Line 814-818 (속도, 냉각수 유량)
CASE WHEN srlzone18_26 BETWEEN AVG(...) - (1.5 * STDDEV(...))
                           AND AVG(...) + (1.5 * STDDEV(...))
THEN srlzone18_26 END AS srlzone18_26

-- Line 845 (속도)
CASE WHEN srlzone07_5 BETWEEN AVG(...) - (1.5 * STDDEV(...))
                          AND AVG(...) + (1.5 * STDDEV(...))
THEN srlzone07_5 END AS srlzone07_5

-- Line 886-892 (LOOP 관련 데이터)
CASE WHEN srlzone0801_29 BETWEEN AVG(...) - (1.5 * STDDEV(...))
                             AND AVG(...) + (1.5 * STDDEV(...))
THEN srlzone0801_29 END AS srlzone0801_29
```

**의미**:
- 평균 ± 1.5σ 범위 밖의 이상치 제거
- 센서 오류나 급격한 변동 제외
- 정상 작업 구간 데이터만 수집

**적용 대상**:
- 냉각수 유량 (srlzone*_7, srlzone*_8, srlzone*_27, srlzone*_28)
- 압연 속도 (srlzone18_26, srlzone07_5)
- LOOP 관련 센서 (srlzone0801_29, 32, 35, 36, 39)
- COMBINED SHEAR (srlzone09_1)

---

## 6. 최종 집계 방식 차이

### 원본 (Line 2750-2752)
```sql
ARRAY_AGG(srlzone0401_1 IGNORE NULLS ORDER BY stats_sec_dtm) srlzone0401_1,
ARRAY_AGG(srlzone0401_2 IGNORE NULLS ORDER BY stats_sec_dtm) srlzone0401_2,
...
GROUP BY heat_no, m_lot_no, lot_no_seq_no, ..., zone_id, zone_nm, entry_dtm, exit_dtm
```

**결과**:
- heat_no + zone별 초 단위 배열 데이터
- 한 행에 수백~수천 개의 타임스탬프 데이터

### 변경 (Line 131-580)
```sql
SELECT
    DATE(MIN(rm_entry_dtm)) AS rm_work_dte,
    MIN(rm_entry_dtm) AS rm_entry_dtm,
    lot_no,
    lot_no_seq_no AS serial_no,
    heat_no,
    CAST(str_no AS STRING) AS strnd_no,
    CAST(ser_no AS STRING) AS strnd_seq,

    -- 평균값
    ROUND(AVG(srlzone0401_16), 4) AS avg_srlzone0401_16,
    ROUND(AVG(srlzone0401_9), 4) AS avg_srlzone0401_9,
    ...

    -- 표준편차
    CAST(ROUND(STDDEV(srlzone0401_16), 4) AS NUMERIC) AS std_dev_srlzone0401_16,
    CAST(ROUND(STDDEV(srlzone0401_9), 4) AS NUMERIC) AS std_dev_srlzone0401_9,
    ...

FROM (... 필터링된 서브쿼리 ...) AS result
GROUP BY heat_no, str_no, ser_no, lot_no, lot_no_seq_no
```

**결과**:
- heat_no + lot별 집계된 평균/표준편차
- 소수점 4자리로 반올림
- 한 행에 약 400개의 통계 지표

---

## 7. Zone 처리 범위 차이

| 항목 | 원본 | 변경 |
|-----|------|------|
| **처리 Zone 수** | 25개 | 11개 |
| **Zone 목록** | ZONE03~21 전체 | Zone04, 07, 08, 09, 10, 11, 12, 13, 18 |
| **대상 설비** | 전 공정 | **주요 압연 설비만** |

### 원본 Zone (25개)
```sql
Z0301, Z0302,           -- Zone03
Z0401, Z0402,           -- Zone04
Z0601~Z0607,            -- Zone06 (7개)
Z0700,                  -- Zone07
Z0801, Z0803, Z0804,    -- Zone08
Z0900,                  -- Zone09
Z1000,                  -- Zone10
Z1100,                  -- Zone11
Z1202,                  -- Zone12
Z1300,                  -- Zone13
Z1400,                  -- Zone14
Z1500,                  -- Zone15
Z1800,                  -- Zone18
Z2000,                  -- Zone20
Z2100                   -- Zone21
```

### 변경 Zone (11개) - Line 110-130
```sql
z0401 -- Zone4-ST1_4 (조압연기 STAND1-4)
z0402 -- Zone4-ST5_8 (조압연기 STAND5-8)
z18   -- Zone18-STAND9_SHEAR10 (STAND9, 전단기10)
z07   -- Zone7-KOCKS500 (KOCKS 중압연기)
z0801 -- Zone8-3LOOP (3루프)
z0803 -- Zone8-RSB (리듀싱 사이징 밀)
z09   -- Zone9-COMBINED_SHEAR (통합 전단기)
z10   -- Zone10-PREFINISHING (사상압연기)
z11   -- Zone11-NTM (마무리압연기)
z1202 -- Zone12-RSM
z13   -- Zone13-RTD_LH (레잉헤드)
```

**선택 기준**:
- 핵심 압연 설비만 선택
- 품질에 직접적인 영향을 주는 Zone
- Zone03 (가열로), Zone06 (산세), Zone14-21 (검사/포장) 제외

---

## 8. 에러 처리 추가

### 변경 파일 (Line 1073-1075)
```sql
EXCEPTION
    WHEN ERROR THEN
    SELECT @@error.message;
END
```

**목적**: 실행 중 에러 발생 시 에러 메시지 출력

---

## 9. 성능 최적화

| 항목 | 원본 | 변경 | 개선 효과 |
|-----|------|------|----------|
| **데이터 범위** | 전체 초 단위 | 필터링 후 집계 | 데이터량 1/100 이하 |
| **Zone 수** | 25개 | 11개 | JOIN 연산 56% 감소 |
| **출력 행 수** | heat × zone × sec | heat × lot | 시간당 수십만 → 수백 |
| **강종 필터링** | 후처리 | WHERE 절 (Line 42) | 쿼리 실행 시간 단축 |
| **시간 범위** | entry~exit 전체 | 토크 기반 구간 | 불필요한 데이터 제외 |

---

## 10. 추가된 로직 요약표

| 구분 | 원본 | 변경본 | 목적 |
|-----|------|--------|------|
| **데이터 형태** | 원시 시계열 배열 | 통계 집계값 | 분석용 데이터 변환 |
| **데이터 품질** | 전체 수집 | **이상치 제거** | 품질 향상 |
| **처리 범위** | 전 Zone | **핵심 Zone** | 성능 최적화 |
| **시간 필터링** | entry~exit 전체 | **토크 기반 구간** | 실제 작업 구간만 |
| **온도 필터링** | 없음 | **임계값 적용** | 설비 가동 시간만 |
| **집계 방식** | ARRAY_AGG | **AVG + STDDEV** | 통계 분석 가능 |
| **출력 테이블** | srl_tag.mid_stats_rt | comm_analy.sts_analy_srl_mid_match_avg_stdev_st | 분석 전용 테이블 |

---

## 11. 주요 필터링 대상 센서

### 토크 기반 필터링 (p_torque_std >= 5)
- `srlzone0401_16` (STAND1 토크)
- `srlzone0401_24` (STAND2 토크)
- `srlzone0401_32` (STAND3 토크)
- `srlzone0401_40` (STAND4 토크)
- `srlzone0402_10`, `18`, `26`, `34` (STAND5-8 토크)
- `srlzone18_32`, `15` (STAND9-10 토크)
- `srlzone07_42`, `21`, `31` (STAND9-15 토크)
- `srlzone0801_5`, `19` (STAND18-19 토크)
- `srlzone1202_2` (RSM 토크)

### 온도 필터링
- `srlzone0401_4 > 600℃` (Zone04 온도)
- `srlzone0402_1 > 400℃` (Zone04 온도)
- `srlzone07_2 > 600℃` (Zone07 온도)

### 이상치 제거 (평균 ± 1.5σ)
- **냉각수 유량**: srlzone0401_7, 8 / srlzone18_27, 28
- **압연 속도**: srlzone18_26 / srlzone07_5
- **LOOP 데이터**: srlzone0801_29, 32, 35, 36, 39
- **전단기**: srlzone09_1

---

## 12. 결론 및 활용 방안

### 파일별 역할

#### 원본 (pc_sts_analy_srl_mid_match)
- **목적**: 원시 데이터 수집 및 저장
- **용도**:
  - 상세 이력 추적
  - 문제 발생 시 원인 분석
  - 시계열 패턴 분석
- **데이터**: 초 단위 전체 센서 데이터 배열

#### 변경 (pc_sts_analy_srl_mid_match_avg_stdev_st)
- **목적**: ML/AI 학습용 Feature 생성
- **용도**:
  - 품질 예측 모델 학습
  - 공정 이상 탐지
  - 통계적 공정 관리 (SPC)
- **데이터**: 집계된 평균/표준편차 (약 400개 지표)

### 추가된 핵심 로직 정리

1. ✅ **토크 기반 실제 압연 구간 추출** (p_torque_std >= 5)
   - 실제 작업 중인 시간만 선택
   - 대기 시간 제외

2. ✅ **온도 임계값 필터링** (600℃ / 400℃ 이상)
   - 설비 가동 온도 구간만 수집
   - 예열/냉각 시간 제외

3. ✅ **통계적 이상치 제거** (평균 ± 1.5σ 범위)
   - 센서 오류 제거
   - 급격한 변동 제외
   - 정상 작업 범위 데이터만 수집

4. ✅ **평균/표준편차 계산** (소수점 4자리)
   - 각 센서별 통계 지표 생성
   - ML Feature로 바로 활용 가능

5. ✅ **핵심 Zone만 선택** (25개 → 11개)
   - 품질에 직접 영향을 주는 설비만
   - 쿼리 성능 향상

6. ✅ **강종 필터링 최적화** (WHERE 절로 전진 배치)
   - 대상 강종: 316LDS1, STS410S5, STS304SX, STS303S1, 316LDSZ
   - 쿼리 실행 시간 단축

7. ✅ **에러 처리 추가** (EXCEPTION WHEN ERROR)
   - 실행 실패 시 에러 메시지 확인 가능

---

## 13. 참고사항

### 파라미터 설정
```sql
p_datetime: 기본값 2일 전 (조정 가능)
p_torque_std: 기본값 5 (압연기 토크 임계값)
```

### 처리 시간 범위
- 원본: entry_dtm ~ exit_dtm 전체 (6시간 이내)
- 변경: p_datetime ± 18시간 범위 내 데이터

### 이상치 제거 기준
- 1.5σ 범위 (약 86.6% 데이터 포함)
- 3σ로 변경 시 약 99.7% 데이터 포함 (조정 가능)

---

**문서 작성일**: 2025-10-15
**작성자**: Claude Code
**버전**: 1.0
